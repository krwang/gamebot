<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI vs. AI - Rock-Paper-Scissors</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f7fa;
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            padding-top: 0;
            margin-top: 0;
        }
        .navbar {
            background: white !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }
        .navbar-brand {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.5rem;
        }
        .nav-link.active {
            color: #1a73e8 !important;
            text-decoration: underline;
            text-underline-offset: 4px;
            text-decoration-thickness: 2px;
        }
        .nav-link {
            color: #2c3e50;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
            text-decoration: none;
        }
        .nav-link:hover {
            color: #1a73e8;
        }
        .game-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 80px; /* Add margin to account for fixed navbar */
        }
        .welcome-message {
            text-align: center;
            margin-bottom: 2rem;
        }
        .welcome-message h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        .welcome-message p {
            font-size: 1.2rem;
            color: #34495e;
            margin-bottom: 0.5rem;
        }
        .model-selection {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .model-selection h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .model-select {
            margin-bottom: 1rem;
        }
        .rounds-input {
            margin: 1rem 0;
        }
        .rounds-input input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 1rem;
        }
        .start-battle-btn {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 1rem;
        }
        .start-battle-btn:hover {
            background-color: #1557b0;
            transform: translateY(-2px);
        }
        .battle-area {
            display: none;
            background: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .battle-area h3 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .choice-display {
            font-size: 3rem;
            text-align: center;
            margin: 1rem 0;
            transition: transform 0.3s ease;
        }
        .choice-display.active {
            transform: scale(1.2);
        }
        .vs-text {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin: 1rem 0;
        }
        .score-display {
            font-size: 1.5rem;
            text-align: center;
            margin: 1rem 0;
            color: #2c3e50;
        }
        .round-display {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 1rem;
        }
        .battle-result {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 4px;
            display: none;
        }
        .battle-result.win {
            background-color: rgba(30, 126, 52, 0.15);
            color: #1e7e34;
        }
        .battle-result.lose {
            background-color: rgba(200, 35, 51, 0.15);
            color: #c82333;
        }
        .battle-result.tie {
            background-color: rgba(73, 80, 87, 0.15);
            color: #495057;
        }
        .model-name {
            font-size: 1.4em;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            margin: 0 auto 15px;
            width: fit-content;
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="/">RPS.AI</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Play Default AI</a>
                <a class="nav-link" href="/custom-ai">Play Against Your Own AI</a>
                <a class="nav-link active" href="/ai-vs-ai">AI vs. AI</a>
                <a class="nav-link" href="/game-history">Game History</a>
            </div>
        </div>
    </nav>

    <div class="game-container">
        <div class="welcome-message">
            <h1>AI vs. AI Battle</h1>
            <p>Watch two AI models compete against each other in Rock-Paper-Scissors!</p>
        </div>

        <div class="model-selection">
            <h3>Select AI Models</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="model-select">
                        <label for="model1" class="form-label">AI Model 1</label>
                        <select class="form-select" id="model1">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="model-select">
                        <label for="model2" class="form-label">AI Model 2</label>
                        <select class="form-select" id="model2">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="rounds-input">
                <label for="rounds" class="form-label">Number of Rounds</label>
                <input type="number" id="rounds" class="form-control" min="1" max="100" value="10">
            </div>
            <button class="start-battle-btn" onclick="startBattle()">Start Battle</button>
        </div>

        <div class="battle-area" id="battleArea">
            <h3>Battle in Progress</h3>
            <div class="round-display" id="roundDisplay">Round 1 of 10</div>
            <div class="row">
                <div class="col-md-5">
                    <div class="model-name" id="model1Name"></div>
                    <div class="choice-display" id="model1Choice">✊</div>
                    <div class="score-display" id="model1Score">Score: 0</div>
                </div>
                <div class="col-md-2">
                    <div class="vs-text">VS</div>
                    <div class="score-display" id="tieScore">Ties: 0</div>
                </div>
                <div class="col-md-5">
                    <div class="model-name" id="model2Name"></div>
                    <div class="choice-display" id="model2Choice">✊</div>
                    <div class="score-display" id="model2Score">Score: 0</div>
                </div>
            </div>
            <div class="battle-result" id="battleResult"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load available models when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/list-models')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading models:', data.error);
                        return;
                    }
                    
                    const model1Select = document.getElementById('model1');
                    const model2Select = document.getElementById('model2');
                    
                    // Clear loading message
                    model1Select.innerHTML = '<option value="">Select a model</option>';
                    model2Select.innerHTML = '<option value="">Select a model</option>';
                    
                    // Add models to both dropdowns
                    data.models.forEach(model => {
                        const option1 = document.createElement('option');
                        option1.value = model;
                        option1.textContent = model;
                        
                        const option2 = document.createElement('option');
                        option2.value = model;
                        option2.textContent = model;
                        
                        model1Select.appendChild(option1);
                        model2Select.appendChild(option2);
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });

        function startBattle() {
            const model1 = document.getElementById('model1').value;
            const model2 = document.getElementById('model2').value;
            const rounds = parseInt(document.getElementById('rounds').value);
            
            if (!model1 || !model2) {
                alert('Please select both models to start the battle!');
                return;
            }
            
            if (model1 === model2) {
                alert('Please select two different models!');
                return;
            }
            
            if (isNaN(rounds) || rounds < 1 || rounds > 100) {
                alert('Please enter a valid number of rounds (1-100)!');
                return;
            }
            
            // Show battle area
            const battleArea = document.getElementById('battleArea');
            battleArea.style.display = 'block';
            
            // Set model names
            document.getElementById('model1Name').textContent = model1;
            document.getElementById('model2Name').textContent = model2;
            
            // Reset scores and display
            document.getElementById('model1Score').textContent = 'Score: 0';
            document.getElementById('model2Score').textContent = 'Score: 0';
            document.getElementById('tieScore').textContent = 'Ties: 0';
            document.getElementById('roundDisplay').textContent = `Round 1 of ${rounds}`;
            document.getElementById('battleResult').style.display = 'none';
            
            // Disable the start button
            const startButton = document.querySelector('.start-battle-btn');
            startButton.disabled = true;
            startButton.textContent = 'Battle in Progress...';
            
            console.log('Starting battle between', model1, 'and', model2, 'for', rounds, 'rounds');
            
            // Start the battle
            fetch('/api/ai-battle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    model1: model1,
                    model2: model2,
                    rounds: rounds
                })
            })
            .then(response => {
                console.log('Received response, setting up stream reader');
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function processStream({ done, value }) {
                    if (done) {
                        console.log('Stream complete');
                        // Re-enable the start button
                        startButton.disabled = false;
                        startButton.textContent = 'Start Battle';
                        return;
                    }
                    
                    const text = decoder.decode(value);
                    console.log('Received chunk:', text);
                    const lines = text.split('\n').filter(line => line.trim());
                    
                    lines.forEach(line => {
                        console.log('Processing line:', line);
                        const data = JSON.parse(line);
                        console.log('Parsed data:', data);
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        if (data.final) {
                            console.log('Received final result');
                            // Show final result
                            const resultDiv = document.getElementById('battleResult');
                            resultDiv.style.display = 'block';
                            
                            if (data.model1_score > data.model2_score) {
                                resultDiv.className = 'battle-result win';
                                resultDiv.textContent = `${model1} wins!`;
                            } else if (data.model2_score > data.model1_score) {
                                resultDiv.className = 'battle-result lose';
                                resultDiv.textContent = `${model2} wins!`;
                            } else {
                                resultDiv.className = 'battle-result tie';
                                resultDiv.textContent = "It's a tie!";
                            }
                        } else {
                            console.log('Processing round:', data.round);
                            // Update round display
                            document.getElementById('roundDisplay').textContent = `Round ${data.round} of ${rounds}`;
                            
                            // Update scores
                            document.getElementById('model1Score').textContent = `Score: ${data.model1_score}`;
                            document.getElementById('model2Score').textContent = `Score: ${data.model2_score}`;
                            document.getElementById('tieScore').textContent = `Ties: ${data.draws}`;
                            
                            // Update choices
                            const model1Choice = document.getElementById('model1Choice');
                            const model2Choice = document.getElementById('model2Choice');
                            
                            // Add a delay before showing the choices
                            setTimeout(() => {
                                model1Choice.textContent = getEmoji(data.model1_choice);
                                model2Choice.textContent = getEmoji(data.model2_choice);
                                
                                // Add animation
                                model1Choice.classList.add('active');
                                model2Choice.classList.add('active');
                                
                                setTimeout(() => {
                                    model1Choice.classList.remove('active');
                                    model2Choice.classList.remove('active');
                                }, 500);
                            }, 500);
                        }
                    });
                    
                    return reader.read().then(processStream);
                }
                
                return reader.read().then(processStream);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred during the battle: ' + error.message);
                // Re-enable the start button in case of error
                startButton.disabled = false;
                startButton.textContent = 'Start Battle';
            });
        }

        function getEmoji(choice) {
            switch (choice) {
                case 'rock': return '✊';
                case 'paper': return '✋';
                case 'scissors': return '✌️';
                default: return '❓';
            }
        }
    </script>
</body>
</html>